
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>martinciu&#8217;s dev blog</title>
  <meta name="author" content="Marcin Ciunelis">

  
  <meta name="description" content="What is Hubot? Hubot was an almost mythical GitHub campfire bot. They use it for deploying, automate a lot of tasks, and to be a source of fun in the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://martinciu.com/index.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="martinciu's dev blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='https://fonts.googleapis.com/css?family=Noto+Serif:400,700' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
<script src="/javascripts/application.js" type="text/javascript"></script>
<script type="text/javascript" src="/javascripts/jquery.githubRepoWidget.min.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-152335-13']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">martinciu&#8217;s dev blog</a></h1>
  
    <h2>about ruby, rails, javascript, nodejs, coffeescript, objective-c, swift</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  
  
</ul>

<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/contact">Contact me</a></li>
  <li><a href="/projects">Projects</a></li>
  <li><a href="http://linkedin.com/in/martinciu/" target="_blank">LinkedIn</a></li>
  <li><a href="https://github.com/martinciu" target="_blank">Github</a></li>
  <li><a href="http://www.postcatcher.in" target="_blank">PostCatcher</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/11/deploying-hubot-to-heroku-like-a-boss.html">Deploying Hubot to Heroku Like a Boss</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-01T00:00:00+01:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>What is Hubot?</h4>

<p><a href="http://hubot.github.com/">Hubot</a> was an almost mythical GitHub <a href="http://campfirenow.com/">campfire</a> bot. They use it for deploying, automate a lot of tasks, and to be a source of fun in the company. Was, because they <a href="https://github.com/blog/968-say-hello-to-hubot">open sourced</a> it some time age.</p>

<h4>Hubot &amp; Heroku</h4>

<p>When I decided to give hubot a try on <a href="http://www.heroku.com/">Heroku</a> I googled for it and found <a href="https://github.com/github/hubot/wiki/Hubot-on-Heroku">a few</a> <a href="http://apocryph.org/2011/10/29/how-i-got-hubot-deployed-to-heroku/">tutorials</a> and <a href="http://jonmagic.com/blog/archives/2011/10/28/hipchat-hubot-and-me">blog posts</a>. All of them advise to download (or clone) main <a href="https://github.com/github/hubot">hubot repository</a> and deploy it to heroku. In may opinion this is not the best way to do it. This post describes how to create separated deployable hubot application.</p>

<h4>Tools needed</h4>

<p>You will need a <a href="http://www.ruby-lang.org">ruby</a>, <a href="http://git-scm.com/">git</a>, <a href="http://nodejs.org/">node.js</a>, <a href="http://npmjs.org/">npm</a> and a heroku gem installed. Ruby and git is pretty common. You will install heroku gem by:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>gem install heroku</code></pre></div>


<p>then node.js with Homebrew</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>brew install node</code></pre></div>


<p>and npm</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl http://npmjs.org/install.sh <span class="p">|</span> sh</code></pre></div>


<h4>Things done locally</h4>

<p>Clone <a href="https://github.com/github/hubot">hubot repository</a> and create a new directory that will deployed to heroku.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>git clone git://github.com/github/hubot.git
<span class="nv">$ </span><span class="nb">cd </span>hubot
<span class="nv">$ </span>npm install    <span class="c"># install all required dependencies</span>
<span class="nv">$ </span>bin/hubot --create ../acmebot</code></pre></div>


<p>If you go to the created directory you should see file structure similar to this:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> ../acmebot
<span class="nv">$ </span>ls -l
~/www/blog/hubot/acmebot  
total 32
-rw-r--r--   <span class="m">1</span> martinciu  staff    <span class="m">36</span> <span class="m">31</span> paź 21:28 Procfile
-rw-r--r--   <span class="m">1</span> martinciu  staff  <span class="m">3411</span> <span class="m">31</span> paź 21:28 README.md
drwxr-xr-x   <span class="m">3</span> martinciu  staff   <span class="m">102</span> <span class="m">31</span> paź 21:28 bin
-rw-r--r--   <span class="m">1</span> martinciu  staff    <span class="m">56</span> <span class="m">31</span> paź 21:28 hubot-scripts.json
-rw-r--r--   <span class="m">1</span> martinciu  staff   <span class="m">518</span> <span class="m">31</span> paź 21:28 package.json
drwxr-xr-x  <span class="m">12</span> martinciu  staff   <span class="m">408</span> <span class="m">31</span> paź 21:28 scripts</code></pre></div>


<p>This will be your hubot application that you will deploy to heroku. First create a new git repository.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>git init .
<span class="nv">$ </span>git add .
<span class="nv">$ </span>git commit -m <span class="s2">&quot;initial commit&quot;</span></code></pre></div>


<p>Now you can create a new heroku app.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>heroku create acmebot --stack cedar</code></pre></div>


<p>And now you can deploy your own hubot to heroku.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>git push heroku</code></pre></div>


<h4>Heroku configuration</h4>

<p>It is deployed, but hubot won&rsquo;t join any <a href="http://campfirenow.com/">campfire</a> room because it doesn&rsquo;t know anything about it. You have to tell him what room(s) should he go to. You can do it by heroku configuration variables.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Campfire user&#39;s token. You can find it on user&#39;s profile pages.</span>
<span class="c"># You should probably have additional campfire user for a hubot </span>
<span class="nv">$ </span>heroku config:add <span class="nv">HUBOT_CAMPFIRE_TOKEN</span><span class="o">=</span>secret
<span class="c"># room ids coma-separated (you can find room id in room URL)</span>
<span class="nv">$ </span>heroku config:add <span class="nv">HUBOT_CAMPFIRE_ROOMS</span><span class="o">=</span><span class="m">123</span> 
<span class="c"># your campfire account subdoamin</span>
<span class="nv">$ </span>heroku config:add <span class="nv">HUBOT_CAMPFIRE_ACCOUNT</span><span class="o">=</span><span class="s2">&quot;acme&quot;</span></code></pre></div>


<p>For some scripts <a href="http://redis.io/">Redis</a> is required. You can add a free <a href="https://redistogo.com/">RedisToGo</a> service by typing:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>heroku addons:add redistogo:nano</code></pre></div>


<p>All is set up. Now you can start hubot:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>heroku ps:scale <span class="nv">app</span><span class="o">=</span>1</code></pre></div>


<h4>It&rsquo;s alive!</h4>

<p>Now if you go to you campfire room and type</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>Hubot <span class="nb">help</span></code></pre></div>


<p>you should get a list of commands that your Hubot is familiar with.</p>

<h4>When it is not alive :/</h4>

<p>If hubot doesn&rsquo;t speak to you, it means that something went wrong. In that case you can check heroku logs by typing in console:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>heroku logs</code></pre></div>


<p>You can also check application status by typing:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>heroku ps</code></pre></div>


<h4>More scripts</h4>

<p>You have just deployed a basic hubot set up. If you want to add more commands you can find them on the <a href="https://github.com/github/hubot-scripts">hubot-scripts  repository</a>. It is already added to you your copy of hubot. To turn it on you should edit <code>hubot-scripts.json</code> file. It is simple JSON file with list of custom scripts that should be loaded. At the time of writing some of the scripts that are available in the hubot-scripts repository are not yet available on the npm. So if your hubot doesn&rsquo;t start after adding some custom scripts, check it&rsquo;s log files to see what scripts can&rsquo;t be found.</p>

<h4>Robot&rsquo;s name</h4>

<p>Hubot only talks to you if you call him by name. And it is a new of the user who&rsquo;s token hubot uses. You can specify that name in the <code>Procfile</code></p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="ss">app</span><span class="p">:</span> <span class="n">bin</span><span class="o">/</span><span class="n">hubot</span> <span class="o">--</span><span class="n">adapter</span> <span class="n">campfire</span> <span class="o">--</span><span class="nb">name</span> <span class="n">acmebot</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">slash</span></code></pre></div>


<p>And if you don&rsquo;t want to talk to hubot by name you can add <code>--enable-slash</code> option. It will allow to replace robot&rsquo;s name with <code>/</code>. Example:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">/mustache me lady gaga</code></pre></div>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/08/how-to-add-api-throttle-to-your-rails-app.html">How to Add API Throttle to Your Rails App</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-08T00:00:00+02:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>Does your app have API?</h4>

<p>Yes? That&rsquo;s awesome! But are you sure that it is safe? And I don&rsquo;t mean if you secured access with api_key, Basic HTTP or anything like this. I mean if it is safe for your severs? At <a href="http://zubibu.com/">zubibu</a> we are going to add API for updating items in customer shops. It is pretty simple and obvious method. But if some API client use it in bad way it can harm us. For example, if an online store with 400 thousands items decided to decrease all prices by 2% for each item, and if they implemented <a href="http://zubibu.com/">zubibu</a> API call after each item update - it could harm us. 400k requests in a very short period of time could be dangerous for many apps.</p>

<h4>How to protect your API?</h4>

<p>You can educate your clients :), you can implement queue for handling API calls on your side. But in most cases (or at least in case described above) queue should be done on the client side. To force implementing queue on the client side you could use API throttling. It should as light as possible and invoked as soon as possible in request processing. So the <a href="http://rack.rubyforge.org/">Rack</a> app sound perfect for this task. You can write your own api throttling app or you can use <a href="https://github.com/datagraph/rack-throttle">rack-throttle</a> gem. It is simple but has almost all required features and is pretty easy to extend. We at <a href="http://zubibu.com/">zubibu</a> needed some custom features, so we decided to extend <code>Rack::Throttle::Limiter</code>. This is our implementation of API throttle. I home comments in code are enough to understand it.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/api_defender.rb</span>
<span class="nb">require</span> <span class="s1">&#39;rack/throttle&#39;</span>
<span class="c1"># we limit daily API usage</span>
<span class="k">class</span> <span class="nc">ApiDefender</span> <span class="o">&lt;</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Throttle</span><span class="o">::</span><span class="no">Daily</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/../config/redis.yml&#39;</span><span class="p">)</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="c1"># we already use Redis in our app, so we reuse it&#39;s </span>
      <span class="c1"># config file here</span>
      <span class="ss">:cache</span> <span class="o">=&gt;</span> <span class="no">Redis</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="n">host</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="n">port</span><span class="p">,</span> <span class="ss">:thread_safe</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:db</span> <span class="o">=&gt;</span> <span class="n">db</span><span class="p">),</span>
      <span class="c1"># if you use staging environment on the same redis server</span>
      <span class="c1"># it is good to have separete key prefix for this</span>
      <span class="ss">:key_prefix</span> <span class="o">=&gt;</span> <span class="s2">&quot;zubibu:</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="si">}</span><span class="s2">:api_defender&quot;</span><span class="p">,</span>
      <span class="c1"># only 5000 request per day</span>
      <span class="ss">:max</span> <span class="o">=&gt;</span> <span class="mi">5000</span>
    <span class="p">}</span>
    <span class="vi">@app</span><span class="p">,</span> <span class="vi">@options</span> <span class="o">=</span> <span class="n">app</span><span class="p">,</span> <span class="n">options</span>
  <span class="k">end</span>

  <span class="c1"># this method checks if request needs throttling. </span>
  <span class="c1"># If so, it increases usage counter and compare it with maximum </span>
  <span class="c1"># allowed API calls. Returns true if a request can be handled.</span>
  <span class="k">def</span> <span class="nf">allowed?</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">need_defense?</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">?</span> <span class="n">cache_incr</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_per_window</span> <span class="p">:</span> <span class="kp">true</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">heders</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="k">super</span>
    <span class="n">request</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="c1"># just to be nice for our clients we inform them how many</span>
    <span class="c1"># requests remaining does they have</span>
    <span class="k">if</span> <span class="n">need_defense?</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
      <span class="n">heders</span><span class="o">[</span><span class="s1">&#39;X-RateLimit-Limit&#39;</span><span class="o">]</span>     <span class="o">=</span> <span class="n">max_per_window</span><span class="o">.</span><span class="n">to_s</span>
      <span class="n">heders</span><span class="o">[</span><span class="s1">&#39;X-RateLimit-Remaining&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_per_window</span> <span class="o">-</span> <span class="p">(</span><span class="n">cache_get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">(</span><span class="n">request</span><span class="p">))</span><span class="o">.</span><span class="n">to_i</span> <span class="k">rescue</span> <span class="mi">1</span><span class="p">)</span><span class="o">].</span><span class="n">max</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span>
    <span class="k">end</span>
    <span class="o">[</span><span class="n">status</span><span class="p">,</span> <span class="n">heders</span><span class="p">,</span> <span class="n">body</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="c1"># rack-throttle can use many backends for storing request counter.</span>
  <span class="c1"># We use Redis only so we can use it&#39;s features. In this case </span>
  <span class="c1"># key increase and key expiration</span>
  <span class="k">def</span> <span class="nf">cache_incr</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">cache_key</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">count</span>
  <span class="k">end</span>

  <span class="kp">protected</span>
    <span class="c1"># only API calls should be throttled</span>
    <span class="k">def</span> <span class="nf">need_defense?</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="no">API_HOST</span>
    <span class="k">end</span>

<span class="k">end</span></code></pre></div>


<p>To add this to your application you to add <a href="https://github.com/datagraph/rack-throttle">rack-throttle</a> to your <code>Gemfile</code></p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Gemfile</span>
<span class="c1">#...</span>
<span class="n">gem</span> <span class="s1">&#39;rack-throttle&#39;</span></code></pre></div>


<p>and run <code>bundle install</code></p>

<p>after that add, <code>ApiDefender</code> middleware to your app&rsquo;s rack stack. It should go as high in the stock as possible:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># config/applicaiton.rb</span>
<span class="nb">require</span> <span class="s1">&#39;lib/api_defender&#39;</span>
<span class="k">module</span> <span class="nn">SomeAwesomeApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="c1"># ...</span>
    <span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">insert_after</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Lock</span><span class="p">,</span> <span class="no">ApiDefender</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>


<p>And thats it! Now, when you access your API you should get response like this:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl -I http://api.someawesomeapp.com/whatever</code></pre></div>




<div class="highlight"><pre><code class="language-bash" data-lang="bash">HTTP/1.1 <span class="m">200</span> OK
X-RateLimit-Limit: 5000
X-RateLimit-Remaining: 4999</code></pre></div>


<p>but if you exceed 5000 API calls you will get this response:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">HTTP/1.1 <span class="m">403</span> Forbidden
X-RateLimit-Limit: 5000
X-RateLimit-Remaining: 0</code></pre></div>


<p>And voilà, your API is more safe now!</p>

<h4>More modifications</h4>

<p>I suggest you reading rack-throttle&rsquo;s <a href="https://github.com/datagraph/rack-throttle/blob/master/README.md">README</a> file as well as it&rsquo;s <a href="https://github.com/datagraph/rack-throttle">source code</a> to find out what else you could easily modify for your needs. For example your <code>ApiDefence</code> middleware could extend <code>Rack::Throttle::Hourly</code> instead of <code>Rack::Throttle::Daily</code>. Your could use different counter store, or identify your clients differently by overriding <code>client_identifier</code> method.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/08/upgrading-to-rails-3-1-rc5.html">Upgrading to Rails 3.1.0.rc5 (From Rc4)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-02T00:00:00+02:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>Rails 3.1.0.rc5</h4>

<p>Rails 3.1.0.rc5 is <a href="http://groups.google.com/group/rubyonrails-talk/browse_thread/thread/ae3139e531b970a2">out</a>. If your app doesn&rsquo;t use rails 3.1 yet you may want to read <a href="http://davidjrice.co.uk/2011/05/25/how-to-upgrade-a-rails-application-to-version-3-1-0.html">this</a> and probably <a href="http://martinciu.com/2011/06/rails-3-1-and-slow-asset-pipeline.html">this</a>. If you have balls and you already use version 3.1, you probably would like to use rc5 ASAP.</p>

<h4>Surprise</h4>

<p>Alright RC releases could not be much different from each other. You may think that simple change in <code>Gemfile</code> make you even more cool.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.1.0.rc5&#39;</span></code></pre></div>


<p>Not this time :). After changing <code>Gemfile</code> and running</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>bundle update rails</code></pre></div>


<p>this line of my template:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/views/layouts/application.html.haml</span>
<span class="o">=</span> <span class="n">stylesheet_link_tag</span> <span class="ss">:contents</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;screen,print&quot;</span></code></pre></div>


<p>throws this error:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">No expansion found <span class="k">for</span> :contents</code></pre></div>


<h4>What has been changed?</h4>

<p>After each major rails upgrade it is always good to generate dummy app and look around what has been changed. I did it and found two little things.</p>

<p>There is a new group in <code>Gemfile</code> called <code>assets</code>.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Gems used only for assets and not required</span>
<span class="c1"># in production environments by default.</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 3.1.0.rc&quot;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 3.1.0.rc&quot;</span>
  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span>
<span class="k">end</span></code></pre></div>


<p>And <code>config/application.rb</code> file has been changed in the way how <a href="http://gembundler.com/">bundler</a> require gems:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># config/application.rb</span>
<span class="no">Bundler</span><span class="o">.</span><span class="n">require</span> <span class="o">*</span><span class="no">Rails</span><span class="o">.</span><span class="n">groups</span><span class="p">(</span><span class="ss">:assets</span><span class="p">)</span> <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">Bundler</span><span class="p">)</span></code></pre></div>


<p>After implementing these changes my app is working under rails 3.1.0.rc5. Hooray!</p>

<p>There may be other differences but none of them breaks my app.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/07/difference-between-class_inheritable_attribute-and-class_attribute.html">Difference Between Class_inheritable_attribute and Class_attribute</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-07T00:00:00+02:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>Deprecation warning</h4>

<p>After you upgrade to Rails 3.1 you may be attacked by deprecation warnings similar to this one:</p>

<blockquote><p>DEPRECATION WARNING: class_inheritable_attribute is deprecated, please use class_attribute method instead. Notice their behavior are slightly different, so refer to class_attribute documentation first. (called from included at base.rb:2)</p></blockquote>

<p>In most case it will probably be all right to replace your all <code>class_inheritable_hash</code>, <code>class_inheritable_array</code>, etc method with <code>class_attribute</code>. Unfortunately it won&rsquo;t always work. There is a &ldquo;slight&rdquo; difference mentioned by warning above.</p>

<h4>What is the difference?</h4>

<p>With <code>class_inheritable_hash</code> (the old way):</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Base</span>
  <span class="n">class_inheritable_hash</span> <span class="ss">:mappings</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">mappings</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">FirstChild</span> <span class="o">&lt;</span> <span class="no">Base</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">mappings</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:bar</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">SecondChild</span> <span class="o">&lt;</span> <span class="no">Base</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">mappings</span><span class="o">[</span><span class="ss">:bar</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:baz</span>
<span class="k">end</span>

<span class="no">Base</span><span class="o">.</span><span class="n">mappings</span>           <span class="c1"># {}</span>
<span class="no">FirstChild</span><span class="o">.</span><span class="n">mappings</span>     <span class="c1"># {:foo=&gt;:bar}</span>
<span class="no">SecondChild</span><span class="o">.</span><span class="n">mappings</span>    <span class="c1"># {:bar=&gt;:baz}</span></code></pre></div>


<p>Alright, this is the expected behavior. How does this code works with <code>class_attribute</code>? Let&rsquo;s see!</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Base</span>
  <span class="n">class_attribute</span> <span class="ss">:mappings</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">mappings</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">FirstChild</span> <span class="o">&lt;</span> <span class="no">Base</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">mappings</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:bar</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">SecondChild</span> <span class="o">&lt;</span> <span class="no">Base</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">mappings</span><span class="o">[</span><span class="ss">:bar</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:baz</span>
<span class="k">end</span>

<span class="no">Base</span><span class="o">.</span><span class="n">mappings</span>           <span class="c1"># {:foo=&gt;:bar, :bar=&gt;:baz}</span>
<span class="no">FirstChild</span><span class="o">.</span><span class="n">mappings</span>     <span class="c1"># {:foo=&gt;:bar, :bar=&gt;:baz}</span>
<span class="no">SecondChild</span><span class="o">.</span><span class="n">mappings</span>    <span class="c1"># {:foo=&gt;:bar, :bar=&gt;:baz}</span></code></pre></div>


<p>It is far from the how it supposed to work. I would&rsquo;t say that <code>class_attribute</code> behavior is &ldquo;slightly&rdquo; different than &ldquo;class_inheritable_hash&rdquo;. It is completely different method! But there is no place for complaining. We have to deal with it. How can we do it? Actually quite simple. Just call <code>dup</code> method on an inheritable attribute:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Base</span>
  <span class="n">class_attribute</span> <span class="ss">:mappings</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">mappings</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">FirstChild</span> <span class="o">&lt;</span> <span class="no">Base</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">mappings</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">mappings</span><span class="o">.</span><span class="n">dup</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">mappings</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:bar</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">SecondChild</span> <span class="o">&lt;</span> <span class="no">Base</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">mappings</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">mappings</span><span class="o">.</span><span class="n">dup</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">mappings</span><span class="o">[</span><span class="ss">:bar</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:baz</span>
<span class="k">end</span>

<span class="no">Base</span><span class="o">.</span><span class="n">mappings</span>           <span class="c1"># {}</span>
<span class="no">FirstChild</span><span class="o">.</span><span class="n">mappings</span>     <span class="c1"># {:foo=&gt;:bar}</span>
<span class="no">SecondChild</span><span class="o">.</span><span class="n">mappings</span>    <span class="c1"># {:bar=&gt;:baz}</span></code></pre></div>


<p>Exactly as expected! Hooray!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/07/building-your-own-hoptoad-app-clone-with-errbit-vmware-cloud-foundry-and-mongodb.html">Building Your Own Hoptoad App Clone With Errbit, VMware Cloud Foundry and MongoDB</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-01T00:00:00+02:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>Disclaimer</h4>

<p>Please note that <a href="http://cloudfoundry.com/" title="Cloud Foundry website">VMware Cloud Foundry</a> is under heavy <a href="https://github.com/cloudfoundry">development</a> right now. It means that some of the things written below might not be valid at time you are reading it. Please leave a comment if you find any outdated stuff.</p>

<h4>Errbit</h4>

<blockquote><p><a href="https://github.com/jdpace/errbit">Errbit</a> is an open source, self-hosted error catcher. It is <a href="http://hoptoadapp.com/pages/home">Hoptoad</a> API compliant so you can just point the <a href="http://hoptoadapp.com/pages/home">Hoptoad</a> notifier at your Errbit server if you are already using <a href="http://hoptoadapp.com/pages/home">Hoptoad</a>.</p></blockquote>

<p>Because Errbit is self-hosted solution you need to have a decent server to run it. You can run it on you own server, you can run it on <a href="http://www.heroku.com/">heroku</a> - details in Errbit&rsquo;s <a href="https://github.com/relevance/errbit/blob/master/README.md">Readme</a> or you can use Cloud Foundry. This post is a simple tutorial how to do it.</p>

<h4>What is VMware Cloud Foundry</h4>

<blockquote><p>Cloud Foundry is the open platform as a service project initiated by VMware. It can support multiple frameworks, multiple cloud providers, and multiple application services all on a cloud scale platform.</p></blockquote>

<p>You can download from Cloud Foundry from GitHub <a href="https://github.com/cloudfoundry">repository</a> and set up your own cloud infrastructure or you can use hosted by VMware one. In this tutorial we use hosted one.</p>

<h4>Cloud Foundry account and VMC tools</h4>

<p>At first we need a <a href="http://cloudfoundry.com/signup">Cloud Foundry account</a>. They was at closed beta at the time I sign up. I had to wait a few days to get an account. I don&rsquo;t know if it still apply. After you get an account install Cloud Foundry <a href="http://support.cloudfoundry.com/entries/20012337-getting-started-guide-command-line-vmc-users">VMC tools</a>. VMC is a command line client for Cloud Foundry.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>gem install vmc</code></pre></div>


<p>Then log in to Cloud Foundry using credentials.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vmc login  
Email: marcin.ciunelis@gmail.com
Password: ******
Successfully logged into <span class="o">[</span>http://api.cloudfoundry.com<span class="o">]</span></code></pre></div>


<p>You may want to change automatically generated password. You can do that using VMC tools:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vmc passwd  
Changing password <span class="k">for</span> <span class="s1">&#39;marcin.ciunelis@gmail.com&#39;</span>
New Password: ******
Verify Password: ******

Successfully changed password</code></pre></div>


<h4>Errbit</h4>

<p><a href="https://github.com/jdpace/errbit">Errbit</a> will not work out of the box on Cloud Foundry. We need to modify it a little. I won&rsquo;t write here how to set up Errbit on your local box. You can find it on project <a href="https://github.com/relevance/errbit/blob/master/README.md">README</a> file. I&rsquo;m going to focus on Cloud Foundry specific issues mainly. First, clone it from GitHub repository.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>git clone git://github.com/jdpace/errbit.git</code></pre></div>


<p>When you open <code>Gemfile</code> you will notice that <code>redmine_client</code> gem is taken from git repository, not from official gem release because official one does not work with Rails3. If you are not going to use <a href="http://www.redmine.org/">Redmine</a> integration you can safely comment that line out. If want to use <a href="http://www.redmine.org/">Redmine</a> you we will need to figure out something smarter :)</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s1">&#39;lighthouse-api&#39;</span>
<span class="c1"># gem &#39;redmine_client&#39;, :git =&gt; &quot;git://github.com/oruen/redmine_client.git&quot;</span>
<span class="n">gem</span> <span class="s1">&#39;mongoid_rails_migrations&#39;</span>
<span class="c1">#...</span></code></pre></div>


<p>The other thing that Cloud Foundry currently does not support is running <code>rake</code> task. Errbit requires running <code>rake errbit:bootstrap</code> which copy <code>config/config.yml</code>, <code>config/mongoid.yml</code> files and seed the database. You can run this task on your local box to create config files.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>rake errbit:bootstrap
Copying example config files...
-- Copying config/config.example.yml to config/config.yml
-- Copying config/deploy.example.rb to config/deploy.rb
-- Copying config/mongoid.example.yml to config/mongoid.yml

Seeding database
-------------------------------
Creating an initial admin user:
-- email:    errbit@errbit.example.com
-- password: password

Be sure to change these credentials ASAP!

Generating indexes <span class="k">for</span> App
Generating indexes <span class="k">for</span> Err
Generating indexes <span class="k">for</span> Notice
Generating indexes <span class="k">for</span> User</code></pre></div>


<p>Edit <code>config/config.yml</code> file amending <code>host</code> (it must be uniqe) and <code>email_from</code> lines. Also production section in your <code>config/mongoid.yml</code> file should looks like this:</p>

<div class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="x">production:</span>
<span class="x">  host: </span><span class="cp">&lt;%=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VCAP_SERVICES&#39;</span><span class="o">]</span> <span class="p">)</span><span class="o">[</span><span class="s1">&#39;mongodb-1.8&#39;</span><span class="o">].</span><span class="n">first</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">][</span><span class="s1">&#39;hostname&#39;</span><span class="o">]</span> <span class="k">rescue</span> <span class="s1">&#39;localhost&#39;</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  port: </span><span class="cp">&lt;%=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VCAP_SERVICES&#39;</span><span class="o">]</span> <span class="p">)</span><span class="o">[</span><span class="s1">&#39;mongodb-1.8&#39;</span><span class="o">].</span><span class="n">first</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">][</span><span class="s1">&#39;port&#39;</span><span class="o">]</span> <span class="k">rescue</span> <span class="mi">27017</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  database:  </span><span class="cp">&lt;%=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VCAP_SERVICES&#39;</span><span class="o">]</span> <span class="p">)</span><span class="o">[</span><span class="s1">&#39;mongodb-1.8&#39;</span><span class="o">].</span><span class="n">first</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">][</span><span class="s1">&#39;db&#39;</span><span class="o">]</span> <span class="k">rescue</span> <span class="s1">&#39;errbit_development&#39;</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  username: </span><span class="cp">&lt;%=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VCAP_SERVICES&#39;</span><span class="o">]</span> <span class="p">)</span><span class="o">[</span><span class="s1">&#39;mongodb-1.8&#39;</span><span class="o">].</span><span class="n">first</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">][</span><span class="s1">&#39;username&#39;</span><span class="o">]</span> <span class="k">rescue</span> <span class="s1">&#39;&#39;</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  password: </span><span class="cp">&lt;%=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VCAP_SERVICES&#39;</span><span class="o">]</span> <span class="p">)</span><span class="o">[</span><span class="s1">&#39;mongodb-1.8&#39;</span><span class="o">].</span><span class="n">first</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">][</span><span class="s1">&#39;password&#39;</span><span class="o">]</span> <span class="k">rescue</span> <span class="s1">&#39;&#39;</span> <span class="cp">%&gt;</span><span class="x"></span></code></pre></div>


<p>Because we use JSON here to decode mongodb configuration, you will add the following line to your <code>Gemfile</code></p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">&#39;json&#39;</span></code></pre></div>


<p>and run <code>bundle install</code> command</p>

<p>To seed database we need to use a little trick. Errbit already use <code>mongoid_rails_migrations</code> so we can use rails migration to do this. Generate migration:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>rails generate migration seed_database</code></pre></div>


<p>and modify to look like this:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">SeedDatabase</span> <span class="o">&lt;</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="s1">&#39;db:seed&#39;</span><span class="o">].</span><span class="n">invoke</span>
    <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="s1">&#39;db:mongoid:create_indexes&#39;</span><span class="o">].</span><span class="n">invoke</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>


<p>One more thing before deploying. Errbit will send an email when error occur in your app. So you should have an valid delivery_method configured. It may be your own SMTP server, <a href="http://aws.amazon.com/ses/">Amazon SES</a> or email app like <a href="http://sendgrid.com/">Sendgrid</a> or <a href="http://postmarkapp.com/">PostmarkApp</a></p>

<h4>Deploy</h4>

<p>To run Errbit we need two servers. One for web-server and one for MongoDB database. Setting this up is really simple. To setup the app and database server type:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vmc push errbit --path<span class="o">=</span>. --url<span class="o">=</span>martinciu-errbit.cloudfoundry.com --mem<span class="o">=</span>128M --runtime<span class="o">=</span>ruby19
Detected a Rails Application, is this correct? <span class="o">[</span>Yn<span class="o">]</span>: 
Creating Application: OK
Would you like to <span class="nb">bind </span>any services to <span class="s1">&#39;errbit&#39;</span>? <span class="o">[</span>yN<span class="o">]</span>: y
The following system services are available::
1. mongodb
2. mysql
3. redis
Please <span class="k">select</span> one you wish to provision: 1
Specify the name of the service <span class="o">[</span>mongodb-e776e<span class="o">]</span>: 
Creating Service: OK
Binding Service: OK
Uploading Application:
  Checking <span class="k">for</span> available resources: OK
  Processing resources: OK
  Packing application: OK
  Uploading <span class="o">(</span>9K<span class="o">)</span>: OK   
Push Status: OK
Staging Application: OK                                                         
Starting Application: OK</code></pre></div>


<p><code>--url</code> should be same as the one you entered in <code>config/config.yml</code> file and it should be unique. That&rsquo;s it you should have now a working application. You can check working apps by</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vmc apps

+-------------+----+---------+-----------------------------------+---------------+
<span class="p">|</span> Application <span class="p">|</span> <span class="c">#  | Health  | URLS                              | Services      |</span>
+-------------+----+---------+-----------------------------------+---------------+
<span class="p">|</span> errbit      <span class="p">|</span> <span class="m">1</span>  <span class="p">|</span> RUNNING <span class="p">|</span> martinciu-errbit.cloudfoundry.com <span class="p">|</span> mongodb-e776e <span class="p">|</span>
+-------------+----+---------+-----------------------------------+---------------+</code></pre></div>


<p>It also shows connected services - mongodb here. You can now visit your errbit app in your browser. You should see a log in screen, but you can not log in because migrations was not run. Cloud Foundry runs migration only if <code>config/database.yml</code> exists. We don&rsquo;t have such file because mongoid uses <code>config/mongid.yml</code> file by default. To force running migration just create an empty <code>database.yml</code> file and update app:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>touch config/database.yml
<span class="nv">$ </span>vmc update errbit
Uploading Application:
  Checking <span class="k">for</span> available resources: OK
  Processing resources: OK
  Packing application: OK
  Uploading <span class="o">(</span>9K<span class="o">)</span>: OK   
Push Status: OK
Stopping Application: OK
Staging Application: OK                                                         
Starting Application: OK</code></pre></div>


<p>Sometimes update doesn&rsquo;t success. In that case stopping and starting service may help.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vmc stop errbit  
Stopping Application: OK

<span class="nv">$ </span>vmc start errbit  
Staging Application: OK                                                         
Starting Application: OK</code></pre></div>


<p>Alright you should be able to log in to your own error catcher app. Just visit chosen URL (<a href="http://martinciu-errbit.cloudfoundry.com/">http://martinciu-errbit.cloudfoundry.com/</a> in my case) and log in with default credentials which are email: <code>errbit@your-app-url.cloudfoundry.com</code> and password: <code>password</code>. You may want to change these default. You can do this by clicking <code>Edit profile</code> button.</p>

<h4>Configuration</h4>

<p>You can now configure your production app that you want be monitored by Errbit. Errbit is compatible with <a href="https://github.com/thoughtbot/hoptoad_notifier">hoptoad_notifier</a> gem, so if you are familiar with this it should be pretty obvious to you. If you don&rsquo;t use hoptoad you should add it to your <code>Gemgile</code></p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s2">&quot;hoptoad_notifier&quot;</span></code></pre></div>


<p>and run <code>bundle install</code> command</p>

<p>You can create new app on the homepage, define who should receive notifications and create a <code>config/errbit.rb</code> file from the code provided by Errbit. In my case this file looks like this:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">HoptoadNotifier</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="s1">&#39;3aa6c74ccabaf61295c1d10813575705&#39;</span>
  <span class="n">config</span><span class="o">.</span><span class="n">host</span>    <span class="o">=</span> <span class="s1">&#39;martinciu-errbit.cloudfoundry.com&#39;</span>
  <span class="n">config</span><span class="o">.</span><span class="n">port</span>    <span class="o">=</span> <span class="mi">80</span>
  <span class="n">config</span><span class="o">.</span><span class="n">secure</span>  <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">port</span> <span class="o">==</span> <span class="mi">443</span>
<span class="k">end</span></code></pre></div>


<p>Unfortunately Errbit overwrites default <a href="https://github.com/thoughtbot/hoptoad_notifier">hoptoad_notifier</a> settings, so you can not use both error catchers at same time. Alright you should now be able to send a test error notification. Just go to you app folder and run:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>rake hoptoad:test</code></pre></div>


<p>You should a lot of dumped XML data and a while later you should receive email notification from Errbit. You can also review the test error on your errbit app. And that it! You have up and running your own Hoptoad clone!</p>

<h4>Something went wrong?</h4>

<p>If something went wrong (it probably will :P) you can find these tools and resources useful:
1. <code>vmc logs errbit</code>
2. <code>vmc files errbit logs</code>
3. <code>vmc help</code>
4. Cloud Foundry <a href="http://support.cloudfoundry.com/home">Forum</a>
5. Cloud Foundry <a href="https://github.com/cloudfoundry">source code</a> on GitHub
6. Errbit <a href="https://github.com/jdpace/errbit">source code</a> on GitHub</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/06/rails-3-1-and-slow-asset-pipeline.html">Rails 3.1 and Slow Asset Pipeline</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-25T00:00:00+02:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>tl;dr;</h4>
<p><strong>Rails 3.1 Asset Pipeline is not slow! It is your app!</strong> If your app became slow after upgrading to Rails 3.1 and you use <a href="http://mongoid.org/">Mongoid</a> &#8211; turn preloading models off. If this won&#8217;t help profile your app with <a href="https://github.com/bhb/rack-perftools_profiler">rack-perftools_profiler</a>.</p>
<h4>Rails 3.1</h4>
<p>Rails 3.1 is out for a while. It has a bunch of <a href="http://weblog.rubyonrails.org/2011/5/22/rails-3-1-release-candidate">new features and enhancements</a> and a bit of <a href="http://www.rubyinside.com/rails-3-1-adopts-coffeescript-jquery-sass-and-controversy-4669.html">controversy</a>. One of the new features that I wanted to play with was the asset pipeline. So after Release Candidate 4 was out I decided to upgrade <a href="http://zubibu.com">zubibu.com</a> to the newest version.</p>
<h4>Upgrade</h4>
<p>It is pretty easy to upgrade. You can find detailed instructions on <a href="http://davidjrice.co.uk/2011/05/25/how-to-upgrade-a-rails-application-to-version-3-1-0.html">David Rice&#8217;s blog post</a>. Some additional fixes are in comments below his post so read them as well. If you want to fully use asset pipeline you also have to modify all urls in your stylesheets from:</p>
<div class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="x">background: #ffffff url(images/backend/bg.png) repeat-x 0 0</span></code></pre></div><p>to:</p>
<div class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="x">background: #ffffff url(</span><span class="cp">&lt;%=</span> <span class="n">asset_path</span> <span class="s2">&quot;backend/bg.png&quot;</span><span class="cp">%&gt;</span><span class="x">) repeat-x 0 0</span></code></pre></div><p>and add <code>.erb</code> extension to all modified <span class="caps">CSS</span> files. One good regular expression should be enough for updating all your files.</p>
<h4>Horror</h4>
<p>I restarted application and then the horror begun. It was impossible to load whole page with all the assts. Some assets returned 500 status code, some load in 30+ seconds. I tried some tricks with linking <code>app/assets/images/</code> folder to <code>public/images/</code>. It helped a lot, as images was not served by rails, but still <span class="caps">CSS</span> and JavaScript files was very slow. If I don&#8217;t reload pages by <code>CMD+R</code> I was able to work, but styling pages was almost impossible.<br />
<img src="/images/posts/2011-06-25-rails-3-1-and-slow-asset-pipeline/assets.jpg" title="slow assets pipeline" alt="slow assets pipeline" /></p>
<h4>Why is it so slow?</h4>
<p>I couldn&#8217;t believe that asset pipeline is so slow. Yes, it should be slower that serving static files from disk but it should not be <span class="caps">THAT</span> slow. I decided to check what is wrong. I created new rails 3.1 application, added one model with scaffold, one stylesheet and one javascript. I started the application and everything was alright. Assets was loading under 50ms. Then I&#8217;ve added more images, stylesheets, and javascripts. About twenty files together. And still everything was running smoothly. We use <a href="http://mongoid.org/">mongoid</a> as an <span class="caps">ORM</span> in <a href="http://zubibu.com">zubibu</a>, so I migrated the only model to <a href="http://mongoid.org/">mongoid</a>. But it still was damn fast! It was fast until I added more models to my test application. After adding 30 models (with relations between them) assets started to load in about 3 seconds each. The models was very simple without any logic &#8211; just a few fields and references each. It means that it could be models them self but the fact that there are many models.</p>
<h4>perftools.rb</h4>
<p>I didn&#8217;t want to dig in <a href="http://mongoid.org/">mongoid</a> source code for ever, so decided to use great profiling tool: <a href="https://github.com/tmm1/perftools.rb">perftools.rb</a> and because I need to profile web app I used <a href="https://github.com/bhb/rack-perftools_profiler">rack-perftools_profiler</a> middleware. I ran profiler two times: first with 1 model and than with 30 models loaded. Reading profile data is quite hard and, I am not the best in this, but I noticed that when app is running with many models loaded it spends much more time in <code>Mongoid::load_models</code> method which looks like this:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno">14</span> <span class="k">def</span> <span class="nf">load_models</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="lineno">15</span>   <span class="k">return</span> <span class="k">unless</span> <span class="o">::</span><span class="no">Mongoid</span><span class="o">.</span><span class="n">preload_models</span>
<span class="lineno">16</span>   <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">paths</span><span class="o">[</span><span class="s2">&quot;app/models&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">path</span><span class="o">|</span>
<span class="lineno">17</span>     <span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">/**/*.rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
<span class="lineno">18</span>       <span class="n">load_model</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">/&quot;</span> <span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;.rb&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
<span class="lineno">19</span>     <span class="k">end</span>
<span class="lineno">20</span>   <span class="k">end</span>
<span class="lineno">21</span> <span class="k">end</span></code></pre></div><p>And what is <code>::Mongoid.preload_models</code>? It is config option turn on by default that reloads all models on each request. According to mongoid <a href="http://mongoid.org/docs/rails/railties.html">documentation</a> you can turn it off if don&#8217;t use single collection inheritance in your app. To turn it off simply add following line to your <code>congif.applicaton</code> file:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">config</span><span class="o">.</span><span class="n">mongoid</span><span class="o">.</span><span class="n">preload_models</span> <span class="o">=</span> <span class="kp">false</span></code></pre></div><p>I did it in my application and it works! It is usable again!</p>






</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/06/blogging-like-a-hacker-using-jekyll-compass-and-foreman.html">Blogging Like a Hacker Using Jekyll, Compass and Foreman</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-17T00:00:00+02:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>You probably already know <a href="http://tom.preston-werner.com/2008/11/17/blogging-like-a-hacker.html">how to blog like a hacker</a> using <a href="http://git-scm.com/">Git</a> and <a href="http://jekyllrb.com/">Jekyll</a> It is realy simple but powerfull way of maintaing personal blog. If you put it&#8217;s code on the <a href="https://github.com/">github</a> like <a href="https://github.com/jeffkreeftmeijer/jeffkreeftmeijer.com">Jeff Kreeftmeijer</a> did you can even count on comunity <a href="pool-request">contribution</a> to your own personal blog. How could is that!</p>
<p>If don&#8217;t use <a href="http://jekyllrb.com/">jekyll</a> for you blog you should definetly reconsider that. If you already do use jekyll you probably know that for developemnt you need to run</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>jekyll --server</code></pre></div><p>to set up simple local server that automatically regenarates static files echa time they are changend. If you also use <a href="http://sass-lang.com/"><span class="caps">SASS</span></a> or <a href="http://compass-style.org/">Compass</a> for your stylesheets you need to run in second terminal</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>sass --watch input-dir:output-dir</code></pre></div><p>or for <a href="comapss">Comapss</a></p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>compass watch</code></pre></div><p>That is preaty annoying to run two processes in two separate terminals.</p>
<h4>Foreman &amp; Procfile</h4>
<p>And this is where <a href="http://blog.daviddollar.org/2011/05/06/introducing-foreman.html">Foreman</a> comes with help. <a href="http://blog.daviddollar.org/2011/05/06/introducing-foreman.html">Foreman</a> is a process manager for applications with multiple components. It manages Procfile-based applications. We have application with two components so this perfetly fits for our needs. All we need is to add <code>Procfile</code> To make it work install foreman by</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>gem install foreman</code></pre></div><p>and create <code>Procfile</code> under root directory</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">jekyll:  jekyll --server
comapss: compass watch</code></pre></div><p>To start both processes just type</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>foreman start</code></pre></div><p>and you should see smething similar to:</p>
<p><img src="/images/posts/2011-06-17-blogging-like-a-hacker-using-jekyll-compass-and-foreman/foreman.png" title="forman start output" alt="forman start output" /></p>
<p>That&#8217;s it! Your are a better now!</p>
<p>Enjoy!</p>







</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/06/rails2.2-bunlder-rack-and-pow.html">Rails 2.2, Bundler, Rack and Pow</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-16T00:00:00+02:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Yesterday I have upgraded our production server. I updated <a href="https://rubygems.org">rubygems</a> to version 1.8.5 and <a href="http://gembundler.com">bundler</a> to 1.1.pre.5. I also updated <a href="http://zuibu.com">zubibu.com</a> &#8216;s staging server by uploading quite a few new gems. One of these actions (or all of them together) broke a few old, low-trafic <a href="http://rubyonrails.org/">rails</a> websites. I didn&#8217;t investigate what exactly did break them. All broken websites had one thing in common &#8211; they were so old that they didn&#8217;t use bunlder to manage gems.</p>
<h4>Bundler</h4>
<p>Most of them was written in rails 2.3, so managing them to user bundler was preaty easy. You can <a href="bunlder-rails23">manual</a> on bundler website how to do it and that simply wokrs. But one of the broken webisetes was running Rails 2.2.2. I googled if such old app can use bundler, but didn&#8217;t find any answers. So I decided to try it. I started with the <a href="http://gembundler.com/rails23.html">inststructions</a> for rails 2.3 app.</p>
<p>I have added this code to the <code>config/boot.rb</code> file right above the line <code>Rails.boot!</code></p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Rails</span><span class="o">::</span><span class="no">Boot</span>
  <span class="k">def</span> <span class="nf">run</span>
    <span class="n">load_initializer</span>

    <span class="no">Rails</span><span class="o">::</span><span class="no">Initializer</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
      <span class="k">def</span> <span class="nf">load_gems</span>
        <span class="vi">@bundler_loaded</span> <span class="o">||=</span> <span class="no">Bundler</span><span class="o">.</span><span class="n">require</span> <span class="ss">:default</span><span class="p">,</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="no">Rails</span><span class="o">::</span><span class="no">Initializer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="ss">:set_load_path</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div><p>Then I created <code>config/preinitializer.rb</code> file</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">begin</span>
  <span class="nb">require</span> <span class="s2">&quot;rubygems&quot;</span>
  <span class="nb">require</span> <span class="s2">&quot;bundler&quot;</span>
<span class="k">rescue</span> <span class="no">LoadError</span>
  <span class="k">raise</span> <span class="s2">&quot;Could not load the bundler gem. Install it with `gem install bundler`.&quot;</span>
<span class="k">end</span>

<span class="k">if</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Version</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Bundler</span><span class="o">::</span><span class="no">VERSION</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Version</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;0.9.24&quot;</span><span class="p">)</span>
  <span class="k">raise</span> <span class="no">RuntimeError</span><span class="p">,</span> <span class="s2">&quot;Your bundler version is too old for Rails 2.3.&quot;</span> <span class="o">+</span>
   <span class="s2">&quot;Run `gem install bundler` to upgrade.&quot;</span>
<span class="k">end</span>

<span class="k">begin</span>
  <span class="c1"># Set up load paths for all bundled gems</span>
  <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;BUNDLE_GEMFILE&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s2">&quot;../../Gemfile&quot;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
  <span class="no">Bundler</span><span class="o">.</span><span class="n">setup</span>
<span class="k">rescue</span> <span class="no">Bundler</span><span class="o">::</span><span class="no">GemNotFound</span>
  <span class="k">raise</span> <span class="no">RuntimeError</span><span class="p">,</span> <span class="s2">&quot;Bundler couldn&#39;t find some gems.&quot;</span> <span class="o">+</span>
    <span class="s2">&quot;Did you run `bundle install`?&quot;</span>
<span class="k">end</span></code></pre></div><p>And created the <code>Gemfile</code></p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>bundle init</code></pre></div><p>I copied there all <code>config.gem</code> directives from <code>confiv/environmet*</code> files and lock the gems at the certain versions as the probably wouldn&#8217;t run with old code.</p>
<p>That would be all from gembundler instructions, so I created a gemset for this faling app and run <code>bundle install</code>. When I try to run tests I got this depracation warning:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">rake/rdoctask is deprecated.  Use rdoc/task instead <span class="o">(</span>in RDoc 2.4.2+<span class="o">)</span></code></pre></div><p>To get rid of it just replace replace one line in your <code>Rakefile</code></p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># require &#39;rake/rdoctask&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;rdoc/task&#39;</span></code></pre></div><p>and add <code>rdoc</code> to your <code>Gemfile</code></p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#...</span>
<span class="n">gem</span> <span class="s1">&#39;rdoc&#39;</span></code></pre></div><p>After <code>bundle install</code> all the tests passed. Yay!</p>
<h4>Pow &amp; Rack</h4>
<p>I run all my rails application using <a href="http://pow.cx/">Pow</a>. This one I wanted to run same as others. I just add a symbolic link in my <code>~./pow</code> folder and visited an .dev url in the browser and I got this message:</p>
<p><img src="/images/posts/2011-06-16-rails2.2-bunlder-rack-and-pow.textile/pow.png" title="If you’re using a version of Rails older than 2.3, you’ll need to upgrade first." alt="If you’re using a version of Rails older than 2.3, you’ll need to upgrade first." /></p>
<p>Not good :(. They advised me to upgrade my application but I realy don&#8217;t want to do. Before I googled how to upgrade from rails 2.2 to 2.3 I decided to give it a try and just add the <code>cofnig.ru</code> file.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/config/environment&#39;</span>
<span class="n">run</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Dispatcher</span><span class="o">.</span><span class="n">new</span></code></pre></div><p>Then I vited app&#8217;s dev url in the browser just to get this message:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="ss">MissingSourceFile</span><span class="p">:</span> <span class="n">no</span> <span class="n">such</span> <span class="n">file</span> <span class="n">to</span> <span class="nb">load</span> <span class="o">--</span> <span class="n">rack</span></code></pre></div><p>To fix it just add <code>gem 'rack'</code> to your <code>Gemfile</code>. Than all works perfectly! Even my old rails 2.2 app.</p>
<h4>tl;dr</h4>
<p>1. <a href="http://gembundler.com">Bundler</a> works with rails 2.2 app.<br />
2. <a href="http://pow.cx/">Pow</a> works with rails 2.2 app even if docs says something else<br />
3. If you want to know how &#8211; read the whole thing!</p>




</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/01/mounting-grape-api-inside-rails-application.html">Mounting Grape API Inside Rails Application</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-07T00:00:00+01:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/intridea/grape">Grape</a> is a <span class="caps">REST</span>-like <span class="caps">API</span> micro-framework for Ruby. It is built to complement existing web application frameworks such as <a href="http://rubyonrails.org/">Rails</a> and <a href="http://www.sinatrarb.com/">Sinatra</a> by providing a simple <span class="caps">DSL</span> to easily provide APIs. It has built-in support for common conventions such as multiple formats, subdomain/prefix restriction, and versioning.  Because <a href="https://github.com/intridea/grape">grape</a> APIs are <a href="http://rack.rubyforge.org/">Rack</a> applications, it is very easy (in rails 3) and quite easy (in rails 2.3) to mount it in your existing rails application.</p>
<h4><span class="caps">API</span></h4>
<p>Let’s start with a simple <span class="caps">API</span>. Assuming you have a simple blog application with Post resource and you want to list all posts and show a specific post by ID using <span class="caps">API</span>.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#lib/api.rb</span>
<span class="k">module</span> <span class="nn">MyApp</span>
  <span class="k">class</span> <span class="nc">API</span> <span class="o">&lt;</span> <span class="no">Grape</span><span class="o">::</span><span class="no">API</span>
    <span class="n">prefix</span> <span class="s2">&quot;api&quot;</span>
 
    <span class="n">resource</span> <span class="s2">&quot;posts&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="k">do</span>
        <span class="no">Post</span><span class="o">.</span><span class="n">all</span>
      <span class="k">end</span>
 
      <span class="n">get</span> <span class="s1">&#39;:id&#39;</span> <span class="k">do</span>
        <span class="no">Post</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
 
  <span class="k">end</span>
<span class="k">end</span></code></pre></div><h4>Rails 3</h4>
<p>Because of Rails3 modularity it is very easy to mount any <a href="http://rack.rubyforge.org/">Rack</a> application inside existing application. You only need to add following line to your <code>config/routes.rb</code> file</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#config/routes.rb</span>
<span class="n">mount</span> <span class="no">MyApp</span><span class="o">::</span><span class="no">API</span> <span class="o">=&gt;</span> <span class="s2">&quot;/&quot;</span> <span class="c1">#API will be available under &quot;/api&quot; url because of setting from MyApp::API line 4</span></code></pre></div><p>After restartig your application, <code>GET /api/posts</code> should returns all posts, and <code>GET /api/posts/2</code> should returns post with id=2. Simple as that.</p>
<h4>Rails 2.3</h4>
<p>If you want to use grape with rails 2.3, things are a little more complicated. We can use the same <code>lib/api.rb</code> file, but we can not mount our <span class="caps">API</span> in <code>config/routes.rb</code>. Fortunately, rails 2.3 is actually a rack application, so we can use <a href="https://github.com/rack/rack/blob/master/lib/rack/cascade.rb">Rack::Cascade</a> to run api request without touching rails app. But, first things first.</p>
<p>When you are starting rails application by <code>ruby script/server</code>, an new <a href="http://rack.rubyforge.org/doc/classes/Rack/Builder.html">Rack::Builder</a> is being initialized with some middleware and new rails dispatcher:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 83</span> <span class="c1"># rails/lib/commands/server.rb</span>
<span class="lineno"> 84</span>   <span class="nb">require</span> <span class="no">RAILS_ROOT</span> <span class="o">+</span> <span class="s2">&quot;/config/environment&quot;</span>
<span class="lineno"> 85</span>   <span class="n">inner_app</span> <span class="o">=</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Dispatcher</span><span class="o">.</span><span class="n">new</span>
<span class="lineno"> 86</span> <span class="k">end</span>
<span class="lineno"> 87</span>  
<span class="lineno"> 88</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:path</span><span class="o">].</span><span class="n">nil?</span>
<span class="lineno"> 89</span>   <span class="n">map_path</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span>
<span class="lineno"> 90</span> <span class="k">else</span>
<span class="lineno"> 91</span>   <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">relative_url_root</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:path</span><span class="o">]</span>
<span class="lineno"> 92</span>   <span class="n">map_path</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:path</span><span class="o">]</span>
<span class="lineno"> 93</span> <span class="k">end</span>
<span class="lineno"> 94</span>  
<span class="lineno"> 95</span> <span class="n">app</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Builder</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span>
<span class="lineno"> 96</span>   <span class="n">use</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">LogTailer</span> <span class="k">unless</span> <span class="n">options</span><span class="o">[</span><span class="ss">:detach</span><span class="o">]</span>
<span class="lineno"> 97</span>   <span class="n">use</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">Debugger</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:debugger</span><span class="o">]</span>
<span class="lineno"> 98</span>   <span class="n">map</span> <span class="n">map_path</span> <span class="k">do</span>
<span class="lineno"> 99</span>     <span class="n">use</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">Static</span> 
<span class="lineno">100</span>     <span class="n">run</span> <span class="n">inner_app</span>
<span class="lineno">101</span>   <span class="k">end</span>
<span class="lineno">102</span> <span class="p">}</span><span class="o">.</span><span class="n">to_app</span></code></pre></div><p>Then, a server runs app. Any server knows how to run it because <code>app</code> is a valid Rack application. So, why can we run rack app our own? Sure we can! The best way to run is to define it in <code>config.ru</code> file. Rails 2.3 is not shipped with it, so you have to create it by your self. Unless you changed default options your <code>config.ru</code> file should looks like this:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">&quot;config/environment&quot;</span>
 
<span class="n">use</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">LogTailer</span>
<span class="n">use</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">Static</span>
<span class="n">run</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Dispatcher</span><span class="o">.</span><span class="n">new</span></code></pre></div><p>Now, you can start your appliction by:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="o">[</span>bundle <span class="nb">exec</span><span class="o">]</span> rackup</code></pre></div><p>Your application should run like before, except logs my looks a little bit different. Now we will add our <span class="caps">API</span> to the application. To do that, we will use <a href="https://github.com/rack/rack/blob/master/lib/rack/cascade.rb">Rack::Cascade</a>. <a href="https://github.com/rack/rack/blob/master/lib/rack/cascade.rb">Rack::Cascade</a> tries an request on several apps, and returns the first response that is not 404 (or in a list of configurable status codes). We want our <span class="caps">API</span> to be as fast and lightweight as possible. That’s why we will add before trying rails application, to avoid all it’s magic when it is not necessary.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">&quot;config/environment&quot;</span>
 
<span class="n">rails_app</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Builder</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
  <span class="n">use</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">LogTailer</span>
  <span class="n">use</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">Static</span>
  <span class="n">run</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Dispatcher</span><span class="o">.</span><span class="n">new</span>
<span class="k">end</span>
 
<span class="n">run</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Cascade</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span>
  <span class="no">MyApp</span><span class="o">::</span><span class="no">API</span><span class="p">,</span>
  <span class="n">rails_app</span>
<span class="o">]</span><span class="p">)</span></code></pre></div><p>Now, routes <code>GET /api/posts</code> should disply all posts, and <code>GET /api/posts/2</code> should work as expected.</p>




</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/12/differences-between-proc-new-and-lambda-in-ruby.html">Differences Between Proc.new and Lambda in Ruby</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-27T00:00:00+01:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It will be another not very innovative post about a something that probably most Ruby developers already know. Unfortunately I didn’t know about this  before, and I think it will be a quite good form of this blog, that I will be posting things that I’ve recently learned. So here is what I’ve learned today.</p>
<p><code>Proc.new</code> and <code>lambda</code> does almost the same job. They provide a dynamically created inline method. But they are slightly different. What are the differences? There are two (as far as I know at the moment)</p>
<h4>1. Acceptance of parameters</h4>
<p><code>Proc.new</code> doesn’t care how many parameter do you provide, when <code>lambda</code> needs exact number of parameters. Example:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">pr</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">}</span>
<span class="n">pr</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="c1"># 1</span>
<span class="c1"># 2</span>
<span class="c1"># 3</span></code></pre></div><p>&#8230;and&#8230;</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">pr</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">}</span>
<span class="n">pr</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="c1"># ArgumentError: wrong number of arguments (4 for 3)</span></code></pre></div><h4>2. Returning from a proc<br />
<code>return</code> called in <code>Proc.new</code> block returns from enclosing method when return called in <code>lambda</code> block returns from just a block.<br />
Examples:</h4>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">my_method</span>
  <span class="nb">puts</span> <span class="s2">&quot;Starting my_method&quot;</span>
  <span class="n">pr</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="k">return</span><span class="p">}</span>
  <span class="n">pr</span><span class="o">.</span><span class="n">call</span>
  <span class="nb">puts</span> <span class="s2">&quot;Finishing my_method&quot;</span>
<span class="k">end</span>
 
<span class="nb">puts</span> <span class="s2">&quot;Before my_method&quot;</span>
<span class="n">my_method</span>
<span class="nb">puts</span> <span class="s2">&quot;After my_method&quot;</span>
<span class="c1"># Before my_method</span>
<span class="c1"># Starting my_method</span>
<span class="c1"># After my_method</span></code></pre></div><p>but&#8230;</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">my_method</span>
  <span class="nb">puts</span> <span class="s2">&quot;Starting my_method&quot;</span>
  <span class="n">pr</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span><span class="k">return</span><span class="p">}</span>
  <span class="n">pr</span><span class="o">.</span><span class="n">call</span>
  <span class="nb">puts</span> <span class="s2">&quot;Finishing my_method&quot;</span>
<span class="k">end</span>
 
<span class="nb">puts</span> <span class="s2">&quot;Before my_method&quot;</span>
<span class="n">my_method</span>
<span class="nb">puts</span> <span class="s2">&quot;After my_method&quot;</span>
<span class="c1"># Before my_method</span>
<span class="c1"># Starting my_method</span>
<span class="c1"># Finishing my_method</span>
<span class="c1"># After my_method</span></code></pre></div><p>The other thing that is worth mentioning is that there exist an instruction called <code>proc</code>. What is wired, it works different in ruby 1.8 and in version 1.9. In Ruby 1.8 proc behaviors like <code>lambda</code> when in Ruby 1.9 it works like <code>Proc.ne</code>w. Because of this, and because of ruumors that proc instruction will be removed in ruby 2.0, I don’t recommend using it in your code.</p></div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
   
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:martinciu.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/11/deploying-hubot-to-heroku-like-a-boss.html">Deploying Hubot to Heroku Like a Boss</a>
      </li>
    
      <li class="post">
        <a href="/2011/08/how-to-add-api-throttle-to-your-rails-app.html">How to Add API Throttle to Your Rails App</a>
      </li>
    
      <li class="post">
        <a href="/2011/08/upgrading-to-rails-3-1-rc5.html">Upgrading to Rails 3.1.0.rc5 (From Rc4)</a>
      </li>
    
      <li class="post">
        <a href="/2011/07/difference-between-class_inheritable_attribute-and-class_attribute.html">Difference Between Class_inheritable_attribute and Class_attribute</a>
      </li>
    
      <li class="post">
        <a href="/2011/07/building-your-own-hoptoad-app-clone-with-errbit-vmware-cloud-foundry-and-mongodb.html">Building Your Own Hoptoad App Clone With Errbit, VMware Cloud Foundry and MongoDB</a>
      </li>
    
  </ul>
</section>
<section>
    <a class="twitter-timeline" href="https://twitter.com/martinciu" data-widget-id="535752399613603840">Tweets by @martinciu</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/martinciu">@martinciu</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'martinciu',
            count: 8,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Marcin Ciunelis -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'martinciu';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<script>
  $(document).ready(function() {  
  var stickyNavTop = $('nav').offset().top;  
    
  var stickyNav = function(){  
  var scrollTop = $(window).scrollTop();  
         
  if (scrollTop > stickyNavTop) {   
      $('nav').addClass('sticky');  
  } else {  
      $('nav').removeClass('sticky');   
  }  
  };  
    
  stickyNav();  
    
  $(window).scroll(function() {  
      stickyNav();  
  });  
  });  
</script>

<script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '4e1384ecf5a1f53f55000003');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>




</body>
</html>
